# Copyright: 2020, Chef Software

title "Check for CVE-2020-11651/2"

control "Ensure salt is version 2019.2.4 or 3000.2 or newer" do
  impact 1.0                                
  title "Ensure salt is up-to-date"
  desc "Detects if you are vulnerable to CVE-2020-11651 and CVE-2020-11652"
  packages = %w(salt-api salt-cloud salt-master salt-minion salt-ssh salt-syndic salt)
  packages.each do |pkg|
    describe.one do
      describe package(pkg) do
        its('version') { should be >= '3000.2' }
      end
      describe package(pkg) do
        its('version') { should be >= '2019.2.4' }
      end
      describe package(pkg) do
        it { should_not be_installed }
      end
    end
  end
  describe.one do
    describe command('salt --version | cut -d \' \' -f2') do
      its('stdout.strip') { should be >= '3000.2' }
    end
    describe command('salt --version | cut -d \' \' -f2') do
      its('stdout.strip') { should be >= '2019.2.4' }
    end
    describe command('salt --version') do
      its('stdout.strip') { should be >= '3000.2' }
    end
    describe command('salt --version') do
      its('stdout.strip') { should be >= '2019.2.4' }
    end
    describe command('salt') do
      it { should_not exist }
    end
  end
end
